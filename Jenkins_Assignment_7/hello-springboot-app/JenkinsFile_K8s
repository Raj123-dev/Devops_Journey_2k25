pipeline {
    agent { label "Slave_node" }

    environment {
        IMAGE_NAME = "hello-springboot-app:latest"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Build JAR') {
            steps {
                dir('Jenkins_Assignment_7/hello-springboot-app') {
                    sh 'mvn clean package'
                }
            }
        }

        stage('Build Docker Image in Minikube') {
            steps {
                dir('Jenkins_Assignment_7/hello-springboot-app') {
                    sh '''
                        eval $(minikube docker-env)
                        docker build -t hello-springboot-app:latest .
                    '''
                }
            }
        }

        stage('Deploy to Minikube') {
            steps {
                dir('Jenkins_Assignment_7/hello-springboot-app') {
                    sh 'kubectl apply -f deployment.yaml'
                }
            }
        }
    }

    post {
        always {
            echo 'Checking service URL (optional)'
            sh 'minikube service hello-springboot-app-service --url || true'
        }
    }
}
